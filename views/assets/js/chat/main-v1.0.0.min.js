moment.locale("es");let vm=new Vue({vuetify:vuetify,el:"#siac-suite-container",data:{uid:uid,search_member:"",search_external_member:"",is_opened:!1,getting_messages_loading:!1,privateMessagesInterval:"",group_dialog:!1,dialog_kick:!1,dialog_member_type:!1,dialog_delete_group:!1,dialog_leave_group:!1,dialog_add_external_member:!1,private_chat:!1,external_upcm_dialog:!1,loading:!1,group_loading:!1,upload_file:!1,edit_group_name:!1,user_group_admin:!1,tab:null,message:" ",file_media:null,files:[],chat:[],chat_copy:[],upcm_chats:[],upcm_members:[],upcm_external_members:[],group_chats:[],group_members:[],external_chats:[],external_members:[],selected_member:[],group_form:{group_name:"",members:[],external_members:[]},opened_chat:{user_id:"",first_name:"",last_name:"",email:"",rol:"",telephone:"",messages:[]},external_selected_member:{},member_index:-1,group_index:-1},computed:{},created(){this.initialize()},mounted(){},methods:{initialize(){this.getUPCMChats(),this.getExternalChats(),this.getGroupChats()},getUPCMChats(){var e=this,a=api_url+"chat/get-upcm-chats";e.$http.get(a).then(a=>{if(a.body.length>0){e.upcm_chats=a.body;var t=[];a.body.forEach(e=>{if(e.user_id!=uid){var a={full_name:e.first_name+" "+e.last_name,user_id:e.user_id};t.push(a)}}),e.upcm_members=t,e.upcm_members_list=t}},e=>{})},getAllMembers(){var e=this,a=api_url+"chat/get-all-upcm-members";e.dialog_add_external_member=!0,e.$http.get(a).then(a=>{if(a.body.length>0){var t=[];a.body.forEach(e=>{var a={first_name:e.first_name,avatar:e.avatar,last_name:e.last_name,full_name:e.first_name+" "+e.last_name,user_id:e.user_id,email:e.email,telephone:e.telephone,rol:e.rol};t.push(a)}),e.upcm_external_members=t,e.upcm_external_members_list=t}},e=>{})},getExternalChats(){var e=this,a=api_url+"chat/get-external-upcm-chats";e.$http.get(a).then(a=>{a.body.length>0&&(e.external_chats=a.body)},e=>{})},getGroupChats(){var e=this,a=api_url+"group-chat/get";e.$http.get(a).then(a=>{a.body.length>0&&(e.group_chats=a.body)},e=>{})},getGroupMembers(){var e=this,a=api_url+"group-chat/get-members",t={group_id:e.opened_chat.group_id};e.user_group_admin=!1,e.$http.post(a,t).then(a=>{a.body.length>0&&(e.group_members=a.body,a.body.forEach(a=>{a.user_id==uid&&"administrador"==a.member_type&&(e.user_group_admin=!0)}))},e=>{})},getMessages(){var e=this,a=api_url+"chat/get-messages";data={sender:e.opened_chat.user_id,receiver:uid},e.chat=[],e.getting_messages_loading=!0,e.$http.post(a,data).then(a=>{a.body.length>0?(e.chat=a.body,e.chat_copy=e.filterMessagesByDate(a.body),e.markAsSeen(data)):(e.chat=[],e.chat_copy=[]),""!=e.MessagesInterval&&clearInterval(e.MessagesInterval),function(){vm.getUnreadMessages(),vm.$data.MessagesInterval=setTimeout(arguments.callee,2e3)}(),e.getting_messages_loading=!1},e=>{})},getGroupMessages(){var e=this,a=api_url+"group-chat/get-messages";data={group_id:e.opened_chat.group_id},e.chat=[],e.$http.post(a,data).then(a=>{a.body.length>0?(e.chat=a.body,e.chat_copy=e.filterMessagesByDate(a.body)):(e.chat=[],e.chat_copy=[]),e.getGroupMembers(),""!=e.MessagesInterval&&clearInterval(e.MessagesInterval),function(){vm.getUnreadMessages(),vm.$data.MessagesInterval=setTimeout(arguments.callee,2e3)}(),e.getting_messages_loading=!1},e=>{})},getUnreadMessages(){var e=this;if(!e.getting_messages_loading)if(e.private_chat){e.getting_messages_loading=!0;var a={sender:e.opened_chat.user_id,receiver:uid},t=api_url+"chat/get-unread-messages";e.$http.post(t,a).then(t=>{t.body.length>0&&(t.body.forEach(a=>{parseInt(a.receiver)==uid&&e.chat.push(a)}),e.chat_copy=e.filterMessagesByDate(e.chat),e.markAsSeen(a,!0)),e.getting_messages_loading=!1},a=>{e.getting_messages_loading=!1})}else if(!e.private_chat&&e.opened_chat.hasOwnProperty("group_name")){t=api_url+"group-chat/get-unread-messages",a={group_id:e.opened_chat.group_id,sender:uid,date:e.chat[e.chat.length-1].message_date,time:e.chat[e.chat.length-1].message_time};e.$http.post(t,a).then(a=>{e.getting_messages_loading||(a.body.length>0&&(a.body.forEach(a=>{e.chat.push(a)}),e.chat_copy=e.filterMessagesByDate(e.chat)),e.getting_messages_loading=!1)},a=>{e.getting_messages_loading=!1})}},saveGroup(){var e=this,a=api_url+"group-chat/create-group";if(""==e.group_form.group_name||0==e.group_form.members.length)return!1;e.group_loading=!0,e.$http.post(a,e.group_form).then(a=>{if(e.group_loading=!1,"success"==a.body.status){var t={group_id:a.body.data,group_name:e.group_form.group_name};e.group_chats.push(t),e.group_dialog=!1}},a=>{e.group_loading=!1})},saveGroupTitle(){var e=this,a={},t=api_url+"group-chat/edit-group-name";a={group_id:e.opened_chat.group_id,group_name:e.opened_chat.group_name_copy},e.$http.post(t,a).then(t=>{"success"==t.body.status&&(e.opened_chat.group_name=a.group_name,e.group_chats[e.group_index].group_name=a.group_name,e.edit_group_name=!1)},e=>{})},sendMessage(){var e=this,a=[],t=moment().format("YYYY-MM-DD"),s=moment().format("hh:mm:ss");if(""==e.message&&!upload_file)return!1;var r={receiver:e.opened_chat.user_id,sender:uid,message:e.message,message_time:s,message_date:t,file:null};a=new FormData,e.loading=!0,a.append("receiver",e.opened_chat.user_id),a.append("message",e.message),a.append("file",e.file_media);var o=api_url+"chat/send-message";e.$http.post(o,a).then(a=>{"success"==a.body.status&&(r.file=a.body.data,e.file_media=null,e.loading=!1,e.upload_file=!1,e.chat.push(r),e.chat_copy=e.filterMessagesByDate(e.chat),e.message="")},a=>{e.loading=!1})},markAsSeen(e,a=!1){var t=this,s=api_url+"chat/read-messages";t.$http.post(s,e).then(e=>{a||t.scrollChat()},e=>{a||t.scrollChat()})},sendGroupMessage(){var e=this,a=[],t=moment().format("YYYY-MM-DD"),s=moment().format("hh:mm:ss");if(""==e.message&&!upload_file)return!1;var r={group_id:e.opened_chat.group_id,sender:uid,message:e.message,message_time:s,message_date:t,file:null};a=new FormData,e.loading=!0,a.append("group_id",e.opened_chat.group_id),a.append("message",e.message),a.append("file",e.file_media);var o=api_url+"group-chat/send-message";e.$http.post(o,a).then(a=>{"success"==a.body.status&&(r.file=a.body.data.file,r.message_time=a.body.data.message_time,r.message_date=a.body.data.message_date,e.file_media=null,e.loading=!1,e.upload_file=!1,e.chat.push(r),e.chat_copy=e.filterMessagesByDate(e.chat),e.message="")},a=>{e.loading=!1})},getTimeHour:e=>moment(e).format("h:mm"),openChat(e){var a=this;a.opened_chat=Object.assign({},e),a.dialog_add_external_member=!1,a.private_chat=!0,a.is_opened=!0,a.getMessages()},openGroupChat(e){var a=this;a.private_chat=!1,a.is_opened=!0,a.group_index=a.group_chats.indexOf(e),a.opened_chat=Object.assign({},e),a.opened_chat.group_name_copy=a.opened_chat.group_name,a.getGroupMessages()},scrollChat(){var e=document.getElementById("chat_container");e.scroll(0,4*window.innerHeight)},getExt(e){var a=e.split(".");return a[1]},getExtIcon(e){var a=e.split("."),t="";switch(a[1]){case"pdf":t="pdf";break;case"docx":case"doc":t="word";break;case"ppt":case"pptx":case"ppt":t="powerpoint";break;case"xls":t="excel";break;default:t="document"}return t},prevImage(e,a){if(!e)return!1;var t=new Image,s=window.location.protocol,r=s+"//"+window.location.hostname;"localhost"==window.location.hostname&&(r+=":"+window.location.port),t.src=r+"/public/media/chat/"+e,this.private_chat||(t.src=r+"/public/media/group_chat/"+e);var o=new Viewer(t,{hidden:function(){o.destroy()},title:[1,(e,t)=>a]});o.show()},searchMembers(e){var a=this;a.search_member||(a.upcm_members=a.upcm_members_list),a.upcm_members=a.upcm_members_list.filter(e=>e.full_name.toLowerCase().indexOf(a.search_member.toLowerCase())>-1)},searchExternalMembers(e){var a=this;a.search_external_member||(a.upcm_external_members=a.upcm_external_members_list),a.upcm_external_members=a.upcm_external_members_list.filter(e=>e.full_name.toLowerCase().indexOf(a.search_external_member.toLowerCase())>-1)},assign_member(e){var a=this;a.member_index=a.group_members.indexOf(e),a.selected_member=Object.assign({},e)},deleteMember(){var e=this,a={group_id:e.opened_chat.group_id,user_id:e.selected_member.user_id},t=api_url+"group-chat/kick-member";e.$http.post(t,a).then(a=>{"success"==a.body.status&&(e.group_members.splice(e.member_index,1),e.closeDialogs())},e=>{})},deleteGroup(){var e=this,a={group_id:e.opened_chat.group_id},t=api_url+"group-chat/delete-group";e.$http.post(t,a).then(a=>{"success"==a.body.status&&(e.group_chats.splice(e.group_index,1),e.is_opened=!1,e.closeGroupDialog())},e=>{})},leaveGroup(){var e=this,a={group_id:e.opened_chat.group_id,user_id:uid},t=api_url+"group-chat/leave";e.$http.post(t,a).then(a=>{"success"==a.body.status&&(e.group_chats.splice(e.group_index,1),e.is_opened=!1,e.dialog_delete_group=!1)},e=>{})},openMemberTypeDialog(e){var a=this;a.assign_member(e),a.dialog_member_type=!0},openKickDialog(e){var a=this;a.assign_member(e),a.dialog_kick=!0},closeGroupDialog(){var e=this;e.dialog_delete_group=!1,e.group_index=-1,e.opened_chat=Object.assign({},{}),e.group_members=[]},closeDialogs(){var e=this;e.dialog_kick=!1,e.dialog_member_type=!1,e.member_index=-1,e.selected_member=Object.assign({},{})},changeMemberType(){var e=this,a={group_id:e.opened_chat.group_id,user_id:e.selected_member.user_id,rol:e.selected_member.member_type},t=api_url+"group-chat/change-member-type";e.$http.post(t,a).then(a=>{"success"==a.body.status&&(e.selected_member.member_type="administrador"==e.selected_member.member_type?"miembro":"administrador",Object.assign(e.group_members[e.member_index],e.selected_member),e.closeDialogs())},e=>{})},filterMessagesByDate(e){var a=_.chain(e).groupBy("message_date").value();return a},formatDate(e){var a=moment(e).format("DD [de] MMMM"),t=moment(e).calendar().split(" ");return"hoy"!=t[0]&&"ayer"!=t[0]||(a=t[0]),a}}});