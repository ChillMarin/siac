moment.locale("es");let vm=new Vue({vuetify:vuetify,el:"#siac-suite-container",data:{uid:uid,group_id_by_url:new URLSearchParams(window.location.search).get("group"),search_member:"",search_external_member:"",is_opened:!1,getting_messages_loading:!1,privateMessagesInterval:"",group_dialog:!1,dialog_kick:!1,dialog_member_type:!1,dialog_delete_group:!1,dialog_leave_group:!1,dialog_add_external_member:!1,private_chat:!1,external_upcm_dialog:!1,loading:!1,group_loading:!1,upload_file:!1,edit_group_name:!1,user_group_admin:!1,tab:null,message:" ",file_media:null,files:[],chat:[],chat_copy:[],upcm_chats:[],upcm_members:[],upcm_external_members:[],group_chats:[],group_members:[],external_chats:[],external_members:[],selected_member:[],group_form:{group_name:"",members:[],external_members:[]},opened_chat:{user_id:"",first_name:"",last_name:"",email:"",rol:"",telephone:"",messages:[]},external_selected_member:{},member_index:-1,group_index:-1},computed:{},created(){this.initialize()},mounted(){},methods:{initialize(){this.getUPCMChats(),this.getExternalChats(),this.getGroupChats()},getUPCMChats(){var app=this,url=api_url+"chat/get-upcm-chats";app.$http.get(url).then(res=>{if(res.body.length>0){app.upcm_chats=res.body;var upcm_members=[];res.body.forEach(e=>{if(e.user_id!=uid){var member={full_name:e.first_name+" "+e.last_name,user_id:e.user_id};upcm_members.push(member)}}),app.upcm_members=upcm_members,app.upcm_members_list=upcm_members}},err=>{})},getAllMembers(){var app=this,url=api_url+"chat/get-all-upcm-members";app.dialog_add_external_member=!0,app.$http.get(url).then(res=>{if(res.body.length>0){var upcm_members=[];res.body.forEach(e=>{var member={first_name:e.first_name,avatar:e.avatar,last_name:e.last_name,full_name:e.first_name+" "+e.last_name,user_id:e.user_id,email:e.email,telephone:e.telephone,rol:e.rol};upcm_members.push(member)}),app.upcm_external_members=upcm_members,app.upcm_external_members_list=upcm_members}},err=>{})},getExternalChats(){var app=this,url=api_url+"chat/get-external-upcm-chats";app.$http.get(url).then(res=>{res.body.length>0&&(app.external_chats=res.body)},err=>{})},getGroupChats(){var app=this,url=api_url+"group-chat/get";app.$http.get(url).then(res=>{if(res.body.length>0&&(app.group_chats=res.body,null!=app.group_id_by_url)){var group_chat=app.group_chats.find(e=>e.group_id==app.group_id_by_url);console.log(app.group_chats.indexOf(group_chat)),null!=group_chat&&app.openGroupChat(group_chat)}},err=>{})},getGroupMembers(){var app=this,url=api_url+"group-chat/get-members",id={group_id:app.opened_chat.group_id};app.user_group_admin=!1,app.$http.post(url,id).then(res=>{res.body.length>0&&(app.group_members=res.body,res.body.forEach(e=>{e.user_id==uid&&"administrador"==e.member_type&&(app.user_group_admin=!0)}))},err=>{})},getMessages(){var app=this,url=api_url+"chat/get-messages";data={sender:app.opened_chat.user_id,receiver:uid},app.chat=[],app.getting_messages_loading=!0,app.$http.post(url,data).then(res=>{res.body.length>0?(app.chat=res.body,app.chat_copy=app.filterMessagesByDate(res.body),app.markAsSeen(data)):(app.chat=[],app.chat_copy=[]),""!=app.MessagesInterval&&clearInterval(app.MessagesInterval),function(){vm.getUnreadMessages(),vm.$data.MessagesInterval=setTimeout(arguments.callee,2e3)}(),app.getting_messages_loading=!1},err=>{})},getGroupMessages(){var app=this,url=api_url+"group-chat/get-messages";data={group_id:app.opened_chat.group_id},app.chat=[],app.$http.post(url,data).then(res=>{res.body.length>0?(app.chat=res.body,app.chat_copy=app.filterMessagesByDate(res.body)):(app.chat=[],app.chat_copy=[]),app.getGroupMembers(),""!=app.MessagesInterval&&clearInterval(app.MessagesInterval),function(){vm.getUnreadMessages(),vm.$data.MessagesInterval=setTimeout(arguments.callee,2e3)}(),app.getting_messages_loading=!1},err=>{})},getUnreadMessages(){var app=this;if(!app.getting_messages_loading)if(app.private_chat){app.getting_messages_loading=!0;var data={sender:app.opened_chat.user_id,receiver:uid},url=api_url+"chat/get-unread-messages";app.$http.post(url,data).then(res=>{res.body.length>0&&(res.body.forEach(e=>{parseInt(e.receiver)==uid&&app.chat.push(e)}),app.chat_copy=app.filterMessagesByDate(app.chat),app.markAsSeen(data,!0)),app.getting_messages_loading=!1},err=>{app.getting_messages_loading=!1})}else if(!app.private_chat&&app.opened_chat.hasOwnProperty("group_name")){var url=api_url+"group-chat/get-unread-messages",data={group_id:app.opened_chat.group_id,sender:uid,date:app.chat[app.chat.length-1].message_date,time:app.chat[app.chat.length-1].message_time};app.$http.post(url,data).then(res=>{app.getting_messages_loading||(res.body.length>0&&(res.body.forEach(e=>{app.chat.push(e)}),app.chat_copy=app.filterMessagesByDate(app.chat)),app.getting_messages_loading=!1)},err=>{app.getting_messages_loading=!1})}},saveGroup(){var app=this,url=api_url+"group-chat/create-group";if(""==app.group_form.group_name||0==app.group_form.members.length)return!1;app.group_loading=!0,app.$http.post(url,app.group_form).then(res=>{if(app.group_loading=!1,"success"==res.body.status){var data={group_id:res.body.data,group_name:app.group_form.group_name};app.group_chats.push(data),app.group_dialog=!1}},err=>{app.group_loading=!1})},saveGroupTitle(){var app=this,data={},url=api_url+"group-chat/edit-group-name";data={group_id:app.opened_chat.group_id,group_name:app.opened_chat.group_name_copy},app.$http.post(url,data).then(res=>{"success"==res.body.status&&(app.opened_chat.group_name=data.group_name,app.group_chats[app.group_index].group_name=data.group_name,app.edit_group_name=!1)},err=>{})},sendMessage(){var app=this,data=[],current_date=moment().format("YYYY-MM-DD"),current_time=moment().format("hh:mm:ss");if(""==app.message&&!upload_file)return!1;var raw={receiver:app.opened_chat.user_id,sender:uid,message:app.message,message_time:current_time,message_date:current_date,file:null};data=new FormData,app.loading=!0,data.append("receiver",app.opened_chat.user_id),data.append("message",app.message),data.append("file",app.file_media);var url=api_url+"chat/send-message";app.$http.post(url,data).then(res=>{"success"==res.body.status&&(raw.file=res.body.data,app.file_media=null,app.loading=!1,app.upload_file=!1,app.chat.push(raw),app.chat_copy=app.filterMessagesByDate(app.chat),app.message="")},err=>{app.loading=!1})},markAsSeen(data,noScroll=!1){var app=this,url=api_url+"chat/read-messages";app.$http.post(url,data).then(res=>{noScroll||app.scrollChat()},err=>{noScroll||app.scrollChat()})},sendGroupMessage(){var app=this,data=[],current_date=moment().format("YYYY-MM-DD"),current_time=moment().format("hh:mm:ss");if(""==app.message&&!upload_file)return!1;var raw={group_id:app.opened_chat.group_id,sender:uid,message:app.message,message_time:current_time,message_date:current_date,file:null};data=new FormData,app.loading=!0,data.append("group_id",app.opened_chat.group_id),data.append("message",app.message),data.append("file",app.file_media);var url=api_url+"group-chat/send-message";app.$http.post(url,data).then(res=>{"success"==res.body.status&&(raw.file=res.body.data.file,raw.message_time=res.body.data.message_time,raw.message_date=res.body.data.message_date,app.file_media=null,app.loading=!1,app.upload_file=!1,app.chat.push(raw),app.chat_copy=app.filterMessagesByDate(app.chat),app.message="")},err=>{app.loading=!1})},getTimeHour:d=>moment(d).format("h:mm"),openChat(item){var app=this;app.opened_chat=Object.assign({},item),app.dialog_add_external_member=!1,app.private_chat=!0,app.is_opened=!0,app.getMessages()},openGroupChat(item){var app=this;app.private_chat=!1,app.is_opened=!0,app.group_index=app.group_chats.indexOf(item),app.opened_chat=Object.assign({},item),app.opened_chat.group_name_copy=app.opened_chat.group_name,app.getGroupMessages()},scrollChat(){var container;document.getElementById("chat_container").scroll(0,4*window.innerHeight)},getExt(file_name){var ext;return file_name.split(".")[1]},getExtIcon(file_name){var ext,file_icon="";switch(file_name.split(".")[1]){case"pdf":file_icon="pdf";break;case"docx":case"doc":file_icon="word";break;case"ppt":case"pptx":case"ppt":file_icon="powerpoint";break;case"xls":file_icon="excel";break;default:file_icon="document"}return file_icon},prevImage(src,title){if(!src)return!1;var image=new Image,protocol,domain=window.location.protocol+"//"+window.location.hostname;"localhost"==window.location.hostname&&(domain+=":"+window.location.port),image.src=domain+"/public/media/chat/"+src,this.private_chat||(image.src=domain+"/public/media/group_chat/"+src);var viewer=new Viewer(image,{hidden:function(){viewer.destroy()},title:[1,(image,imageData)=>title]});viewer.show()},searchMembers(e){var app=this;app.search_member||(app.upcm_members=app.upcm_members_list),app.upcm_members=app.upcm_members_list.filter(member=>member.full_name.toLowerCase().indexOf(app.search_member.toLowerCase())>-1)},searchExternalMembers(e){var app=this;app.search_external_member||(app.upcm_external_members=app.upcm_external_members_list),app.upcm_external_members=app.upcm_external_members_list.filter(member=>member.full_name.toLowerCase().indexOf(app.search_external_member.toLowerCase())>-1)},assign_member(item){var app=this;app.member_index=app.group_members.indexOf(item),app.selected_member=Object.assign({},item)},deleteMember(){var app=this,data={group_id:app.opened_chat.group_id,user_id:app.selected_member.user_id},url=api_url+"group-chat/kick-member";app.$http.post(url,data).then(res=>{"success"==res.body.status&&(app.group_members.splice(app.member_index,1),app.closeDialogs())},err=>{})},deleteGroup(){var app=this,data={group_id:app.opened_chat.group_id},url=api_url+"group-chat/delete-group";app.$http.post(url,data).then(res=>{"success"==res.body.status&&(app.group_chats.splice(app.group_index,1),app.is_opened=!1,app.closeGroupDialog())},err=>{})},leaveGroup(){var app=this,data={group_id:app.opened_chat.group_id,user_id:uid},url=api_url+"group-chat/leave";app.$http.post(url,data).then(res=>{"success"==res.body.status&&(app.group_chats.splice(app.group_index,1),app.is_opened=!1,app.dialog_delete_group=!1)},err=>{})},openMemberTypeDialog(item){var app=this;app.assign_member(item),app.dialog_member_type=!0},openKickDialog(item){var app=this;app.assign_member(item),app.dialog_kick=!0},closeGroupDialog(){var app=this;app.dialog_delete_group=!1,app.group_index=-1,app.opened_chat=Object.assign({},{}),app.group_members=[]},closeDialogs(){var app=this;app.dialog_kick=!1,app.dialog_member_type=!1,app.member_index=-1,app.selected_member=Object.assign({},{})},changeMemberType(){var app=this,data={group_id:app.opened_chat.group_id,user_id:app.selected_member.user_id,rol:app.selected_member.member_type},url=api_url+"group-chat/change-member-type";app.$http.post(url,data).then(res=>{"success"==res.body.status&&(app.selected_member.member_type="administrador"==app.selected_member.member_type?"miembro":"administrador",Object.assign(app.group_members[app.member_index],app.selected_member),app.closeDialogs())},err=>{})},filterMessagesByDate(messages){var results;return _.chain(messages).groupBy("message_date").value()},formatDate(d){var format_date=moment(d).format("DD [de] MMMM"),date=moment(d).calendar().split(" ");return"hoy"!=date[0]&&"ayer"!=date[0]||(format_date=date[0]),format_date}}});