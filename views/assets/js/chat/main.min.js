moment.locale("es");let vm=new Vue({vuetify:vuetify,el:"#siac-suite-container",data:{uid:uid,search_member:"",search_external_member:"",is_opened:!1,group_dialog:!1,dialog_kick:!1,dialog_member_type:!1,dialog_delete_group:!1,dialog_leave_group:!1,dialog_add_external_member:!1,private_chat:!1,external_upcm_dialog:!1,loading:!1,group_loading:!1,upload_file:!1,edit_group_name:!1,user_group_admin:!1,tab:null,message:"",file_media:null,files:[],chat:[],chat_copy:[],upcm_chats:[],upcm_members:[],upcm_external_members:[],group_chats:[],group_members:[],external_chats:[],external_members:[],selected_member:[],group_form:{group_name:"",members:[],external_members:[]},opened_chat:{user_id:"",first_name:"",last_name:"",email:"",rol:"",telephone:"",messages:[]},external_selected_member:{},member_index:-1,group_index:-1},computed:{},created:function(){this.initialize()},mounted:function(){},methods:{initialize:function(){this.getUPCMChats(),this.getExternalChats(),this.getGroupChats()},getUPCMChats:function(){var a=this,e=api_url+"chat/get-upcm-chats";a.$http.get(e).then(e=>{var t;0<e.body.length&&(a.upcm_chats=e.body,t=[],e.body.forEach(e=>{e.user_id!=uid&&(e={full_name:e.first_name+" "+e.last_name,user_id:e.user_id},t.push(e))}),a.upcm_members=t,a.upcm_members_list=t)},e=>{})},getAllMembers:function(){var a=this,e=api_url+"chat/get-all-upcm-members";a.dialog_add_external_member=!0,a.$http.get(e).then(e=>{var t;0<e.body.length&&(t=[],e.body.forEach(e=>{e={first_name:e.first_name,avatar:e.avatar,last_name:e.last_name,full_name:e.first_name+" "+e.last_name,user_id:e.user_id,email:e.email,telephone:e.telephone,rol:e.rol};t.push(e)}),a.upcm_external_members=t,a.upcm_external_members_list=t)},e=>{})},getExternalChats:function(){var t=this,e=api_url+"chat/get-external-upcm-chats";t.$http.get(e).then(e=>{0<e.body.length&&(t.external_chats=e.body)},e=>{})},getGroupChats:function(){var t=this,e=api_url+"group-chat/get";t.$http.get(e).then(e=>{0<e.body.length&&(t.group_chats=e.body)},e=>{})},getGroupMembers:function(){var t=this,e=api_url+"group-chat/get-members",a={group_id:t.opened_chat.group_id};t.user_group_admin=!1,t.$http.post(e,a).then(e=>{0<e.body.length&&(t.group_members=e.body,e.body.forEach(e=>{e.user_id==uid&&"administrador"==e.member_type&&(t.user_group_admin=!0)}))},e=>{})},getMessages:function(){var t=this,e=api_url+"chat/get-messages";data={sender:t.opened_chat.user_id,receiver:uid},t.chat=[],t.$http.post(e,data).then(e=>{0<e.body.length?(t.chat=e.body,t.chat_copy=t.filterMessagesByDate(e.body),t.markAsSeen(data)):(t.chat=[],t.chat_copy=[])},e=>{})},getGroupMessages:function(){var t=this,e=api_url+"group-chat/get-messages";data={group_id:t.opened_chat.group_id},t.chat=[],t.$http.post(e,data).then(e=>{0<e.body.length?(t.chat=e.body,t.chat_copy=t.filterMessagesByDate(e.body)):(t.chat=[],t.chat_copy=[]),t.getGroupMembers()},e=>{})},saveGroup:function(){var t=this,e=api_url+"group-chat/create-group";if(""==t.group_form.group_name||0==t.group_form.members.length)return!1;t.group_loading=!0,t.$http.post(e,t.group_form).then(e=>{t.group_loading=!1,"success"==e.body.status&&(e={group_id:e.body.data,group_name:t.group_form.group_name},t.group_chats.push(e),t.group_dialog=!1)},e=>{t.group_loading=!1})},saveGroupTitle:function(){var t=this,e=api_url+"group-chat/edit-group-name",a={group_id:t.opened_chat.group_id,group_name:t.opened_chat.group_name_copy};t.$http.post(e,a).then(e=>{"success"==e.body.status&&(t.opened_chat.group_name=a.group_name,t.group_chats[t.group_index].group_name=a.group_name,t.edit_group_name=!1)},e=>{})},sendMessage:function(){var t=this,e=[],a=moment().format("YYYY-MM-DD"),r=moment().format("hh:mm:ss");if(""==t.message&&!upload_file)return!1;var s={receiver:t.opened_chat.user_id,sender:uid,message:t.message,message_time:r,message_date:a,file:null},e=new FormData;t.loading=!0,e.append("receiver",t.opened_chat.user_id),e.append("message",t.message),e.append("file",t.file_media);a=api_url+"chat/send-message";t.$http.post(a,e).then(e=>{"success"==e.body.status&&(s.file=e.body.data,t.file_media=null,t.loading=!1,t.upload_file=!1,t.chat.push(s),t.chat_copy=t.filterMessagesByDate(t.chat),t.message="")},e=>{t.loading=!1})},markAsSeen:function(e,t){var a=this,r=api_url+"chat/read-messages";a.$http.post(r,e).then(e=>{a.scrollChat()},e=>{a.scrollChat()})},sendGroupMessage:function(){var t=this,e=[],a=moment().format("YYYY-MM-DD"),r=moment().format("hh:mm:ss");if(""==t.message&&!upload_file)return!1;var s={group_id:t.opened_chat.group_id,sender:uid,message:t.message,message_time:r,message_date:a,file:null},e=new FormData;t.loading=!0,e.append("group_id",t.opened_chat.group_id),e.append("message",t.message),e.append("file",t.file_media);a=api_url+"group-chat/send-message";t.$http.post(a,e).then(e=>{"success"==e.body.status&&(s.file=e.body.data,t.file_media=null,t.loading=!1,t.upload_file=!1,t.chat.push(s),t.chat_copy=t.filterMessagesByDate(t.chat),t.message="")},e=>{t.loading=!1})},getTimeHour:function(e){return moment(e).format("h:mm")},openChat:function(e){var t=this;t.opened_chat=Object.assign({},e),t.dialog_add_external_member=!1,t.private_chat=!0,t.is_opened=!0,t.getMessages()},openGroupChat:function(e){var t=this;t.private_chat=!1,t.is_opened=!0,t.group_index=t.group_chats.indexOf(e),t.opened_chat=Object.assign({},e),t.opened_chat.group_name_copy=t.opened_chat.group_name,t.getGroupMessages()},scrollChat:function(){document.getElementById("chat_container").scroll(0,4*window.innerHeight)},getExt:function(e){return e.split(".")[1]},getExtIcon:function(e){var t="";switch(e.split(".")[1]){case"pdf":t="pdf";break;case"docx":case"doc":t="word";break;case"ppt":case"pptx":case"ppt":t="powerpoint";break;case"xls":t="excel";break;default:t="document"}return t},prevImage:function(e,a){if(!e)return!1;var t=new Image,r=window.location.protocol+"//"+window.location.hostname;"localhost"==window.location.hostname&&(r+=":"+window.location.port),t.src=r+"/public/media/chat/"+e,this.private_chat||(t.src=r+"/public/media/group_chat/"+e);var s=new Viewer(t,{hidden:function(){s.destroy()},title:[1,(e,t)=>a]});s.show()},searchMembers:function(e){var t=this;t.search_member||(t.upcm_members=t.upcm_members_list),t.upcm_members=t.upcm_members_list.filter(e=>-1<e.full_name.toLowerCase().indexOf(t.search_member.toLowerCase()))},searchExternalMembers:function(e){var t=this;t.search_external_member||(t.upcm_external_members=t.upcm_external_members_list),t.upcm_external_members=t.upcm_external_members_list.filter(e=>-1<e.full_name.toLowerCase().indexOf(t.search_external_member.toLowerCase()))},assign_member:function(e){this.member_index=this.group_members.indexOf(e),this.selected_member=Object.assign({},e)},deleteMember:function(){var t=this,e={group_id:t.opened_chat.group_id,user_id:t.selected_member.user_id},a=api_url+"group-chat/kick-member";t.$http.post(a,e).then(e=>{"success"==e.body.status&&(t.group_members.splice(t.member_index,1),t.closeDialogs())},e=>{})},deleteGroup:function(){var t=this,e={group_id:t.opened_chat.group_id},a=api_url+"group-chat/delete-group";t.$http.post(a,e).then(e=>{"success"==e.body.status&&(t.group_chats.splice(t.group_index,1),t.is_opened=!1,t.closeGroupDialog())},e=>{})},leaveGroup:function(){var t=this,e={group_id:t.opened_chat.group_id,user_id:uid},a=api_url+"group-chat/leave";t.$http.post(a,e).then(e=>{"success"==e.body.status&&(t.group_chats.splice(t.group_index,1),t.is_opened=!1,t.dialog_delete_group=!1)},e=>{})},openMemberTypeDialog:function(e){this.assign_member(e),this.dialog_member_type=!0},openKickDialog:function(e){this.assign_member(e),this.dialog_kick=!0},closeGroupDialog:function(){this.dialog_delete_group=!1,this.group_index=-1,this.opened_chat=Object.assign({},{}),this.group_members=[]},closeDialogs:function(){this.dialog_kick=!1,this.dialog_member_type=!1,this.member_index=-1,this.selected_member=Object.assign({},{})},changeMemberType:function(){var t=this,e={group_id:t.opened_chat.group_id,user_id:t.selected_member.user_id,rol:t.selected_member.member_type},a=api_url+"group-chat/change-member-type";t.$http.post(a,e).then(e=>{"success"==e.body.status&&(t.selected_member.member_type="administrador"==t.selected_member.member_type?"miembro":"administrador",Object.assign(t.group_members[t.member_index],t.selected_member),t.closeDialogs())},e=>{})},filterMessagesByDate:function(e){return _.chain(e).groupBy("message_date").value()},formatDate:function(e){var t=moment(e).format("DD [de] MMMM"),e=moment(e).calendar().split(" ");return"hoy"!=e[0]&&"ayer"!=e[0]||(t=e[0]),t}}});